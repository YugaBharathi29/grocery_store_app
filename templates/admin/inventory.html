{% extends 'admin/base.html' %}

{% block title %}Inventory Management{% endblock %}

{% block content %}
<div class="container mt-4">
  <h2>Inventory Management</h2>
  <div class="Filters">
    <input type="text" id="searchInput" value="{{ request.args.get('q', '') }}" placeholder="Search products...">
    <select id="categoryFilter">
      <option value="">All Categories</option>
      {% for category in categories %}
      <option value="{{ category.id }}" {% if request.args.get('category', '')|string == category.id|string %}selected{% endif %}>{{ category.name }}</option>
      {% endfor %}
    </select>
    <select id="stockFilter">
      <option value="">All Stock Levels</option>
      <option value="low" {% if request.args.get('filter', '') == 'low' %}selected{% endif %}>Low Stock</option>
      <option value="out" {% if request.args.get('filter', '') == 'out' %}selected{% endif %}>Out of Stock</option>
      <option value="inactive" {% if request.args.get('filter', '') == 'inactive' %}selected{% endif %}>Inactive</option>
      <option value="featured" {% if request.args.get('filter', '') == 'featured' %}selected{% endif %}>Featured</option>
    </select>
    <button id="applyFilters">Filter</button>
  </div>

  <table class="table table-striped">
    <thead>
      <tr>
        <th>ID</th>
        <th>Image</th>
        <th>Name</th>
        <th>Category</th>
        <th>Price</th>
        <th>Stock</th>
        <th>Unit</th>
        <th>Status</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
    {% if products|length == 0 %}
      <tr>
        <td colspan="9" class="text-center">No products found.</td>
      </tr>
    {% else %}
    {% for product in products %}
      <tr>
        <td>{{ product.id }}</td>
        <td><img src="{{ url_for('static', filename=product.image_url or 'no-image.jpg') }}" alt="{{ product.name }}" width="50"></td>
        <td>
          <strong>{{ product.name }}</strong><br>
          <small>{{ product.description|truncate(60) }}</small>
        </td>
        <td>{{ product.category.name }}</td>
        <td>₹{{ product.price }}</td>
        <td {% if product.stock_quantity <= product.min_stock %}style="color:red; font-weight:bold;"{% endif %}>{{ product.stock_quantity }}</td>
        <td>{{ product.unit }}</td>
        <td>{% if product.is_active %}<span class="badge badge-success">Active</span>{% else %}<span class="badge badge-danger">Inactive</span>{% endif %}</td>
        <td>
          <a href="{{ url_for('edit_product', product_id=product.id) }}" class="btn btn-primary btn-sm" title="Edit Product"><i class="fas fa-edit"></i></a>
          <a href="{{ url_for('product_detail', product_id=product.id) }}" class="btn btn-info btn-sm" title="View Product" target="_blank"><i class="fas fa-eye"></i></a>
          <button class="btn btn-secondary btn-sm toggle-status-btn" data-id="{{ product.id }}">
            {% if product.is_active %}Deactivate{% else %}Activate{% endif %}
          </button>
          <button class="btn btn-danger btn-sm delete-btn" data-id="{{ product.id }}"><i class="fas fa-trash"></i></button>
        </td>
      </tr>
    {% endfor %}
    {% endif %}
    </tbody>
  </table>

  <!-- Pagination -->
  {% if pagination.pages > 1 %}
  <nav aria-label="Pagination">
    <ul class="pagination justify-content-center">
      {% if pagination.has_prev %}
      <li class="page-item"><a href="?page={{ pagination.prev_num }}" class="page-link">Previous</a></li>
      {% else %}
      <li class="page-item disabled"><span class="page-link">Previous</span></li>
      {% endif %}

      {% for p in pagination.iter_pages(left_edge=2, right_edge=2, left_current=2, right_current=2) %}
      {% if p %}
      <li class="page-item {% if p == pagination.page %}active{% endif %}"><a href="?page={{ p }}" class="page-link">{{ p }}</a></li>
      {% else %}
      <li class="page-item disabled"><span class="page-link">…</span></li>
      {% endif %}
      {% endfor %}

      {% if pagination.has_next %}
      <li class="page-item"><a href="?page={{ pagination.next_num }}" class="page-link">Next</a></li>
      {% else %}
      <li class="page-item disabled"><span class="page-link">Next</span></li>
      {% endif %}
    </ul>
  </nav>
  {% endif %}

  <script>
    document.getElementById('applyFilters').addEventListener('click', function () {
      var q = document.getElementById('searchInput').value;
      var category = document.getElementById('categoryFilter').value;
      var filter = document.getElementById('stockFilter').value;

      var params = new URLSearchParams(window.location.search);

      if (q) {
        params.set('q', q);
      } else {
        params.delete('q');
      }

      if (category) {
        params.set('category', category);
      } else {
        params.delete('category');
      }

      if (filter) {
        params.set('filter', filter);
      } else {
        params.delete('filter');
      }

      params.delete('page');

      window.location.search = params.toString();
    });

    var toggleButtons = document.querySelectorAll('.toggle-status-btn');
    toggleButtons.forEach(function (btn) {
      btn.addEventListener('click', function () {
        var id = btn.getAttribute('data-id');
        fetch('/admin/toggle_product', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ product_id: id })
        })
        .then(response => response.json())
        .then(function (data) {
          if (data.success) {
            location.reload();
          } else {
            alert(data.message);
          }
        });
      });
    });

    var deleteButtons = document.querySelectorAll('.delete-btn');
    deleteButtons.forEach(function (btn) {
      btn.addEventListener('click', function () {
        if (confirm('Are you sure you want to delete this product?')) {
          var id = btn.getAttribute('data-id');
          fetch('/admin/delete_product/' + id, {
            method: 'POST'
          })
          .then(response => response.json())
          .then(function (data) {
            if (data.success) {
              location.reload();
            } else {
              alert(data.message);
            }
          });
        }
      });
    });
  </script>

  <style>
    .Filters {
      margin-bottom: 20px;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
    }

    .Filters input, .Filters select, .Filters button {
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }

    .Filters button {
      background-color: #007bff;
      color: white;
      border: none;
      cursor: pointer;
    }

    .Filters button:hover {
      background-color: #0056b3;
    }

    img {
      border-radius: 4px;
      max-height: 50px;
      max-width: 50px;
      object-fit: cover;
    }

    .badge {
      font-size: 0.75rem;
      padding: 4px 8px;
      border-radius: 8px;
    }

    .badge-success {
      background-color: #28a745;
      color: white;
    }

    .badge-danger {
      background-color: #dc3545;
      color: white;
    }

    .btn-sm {
      padding: 0.25rem 0.5rem;
      font-size: 0.75rem;
      margin: 2px;
    }

    .table td {
      vertical-align: middle;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      .Filters {
        flex-direction: column;
        align-items: stretch;
      }

      .Filters input, .Filters select, .Filters button {
        width: 100%;
        margin-bottom: 5px;
      }

      table, thead, tbody, th, td, tr {
        display: block;
      }

      thead tr {
        display: none;
      }

      tr {
        border: 1px solid #ccc;
        margin-bottom: 10px;
        padding: 10px;
        border-radius: 8px;
        background-color: #f9f9f9;
      }

      td {
        border: none;
        padding: 5px;
        position: relative;
        padding-left: 50%;
        text-align: right;
      }

      td::before {
        position: absolute;
        top: 6px;
        left: 6px;
        width: 45%;
        padding-right: 10px;
        white-space: nowrap;
        font-weight: bold;
        text-align: left;
      }

      td:nth-of-type(1)::before { content: "ID: "; }
      td:nth-of-type(2)::before { content: "Image: "; }
      td:nth-of-type(3)::before { content: "Name: "; }
      td:nth-of-type(4)::before { content: "Category: "; }
      td:nth-of-type(5)::before { content: "Price: "; }
      td:nth-of-type(6)::before { content: "Stock: "; }
      td:nth-of-type(7)::before { content: "Unit: "; }
      td:nth-of-type(8)::before { content: "Status: "; }
      td:nth-of-type(9)::before { content: "Actions: "; }

      td:nth-of-type(9) {
        text-align: left;
        padding-left: 6px;
      }

      .btn-sm {
        display: block;
        width: 100%;
        margin: 2px 0;
      }
    }
  </style>

{% endblock %}
