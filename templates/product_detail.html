{% extends "base.html" %}

{% block title %}{{ product.name }} - Grocery Store{% endblock %}

{% block content %}
<div class="product-detail-container">
  <!-- Breadcrumb -->
  <nav aria-label="breadcrumb" class="breadcrumb-nav">
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a href="{{ url_for('index') }}">Home</a></li>
      <li class="breadcrumb-item"><a href="{{ url_for('products') }}">Products</a></li>
      <li class="breadcrumb-item"><a href="{{ url_for('products', category_id=product.category_id) }}">{{ product.category.name }}</a></li>
      <li class="breadcrumb-item active">{{ product.name }}</li>
    </ol>
  </nav>

  <div class="product-content">
    <div class="row">
      <!-- Product Image -->
      <div class="col-md-6">
        <div class="product-image-container">
          <img src="{{ url_for('static', filename='images/' + (product.image_url or 'no-image.jpg')) }}" 
               alt="{{ product.name }}" class="product-main-image">
          
          {% if product.original_price and product.original_price > product.price %}
          <div class="sale-badge">
            <span>SALE</span>
            <small>{{ ((product.original_price - product.price) / product.original_price * 100) | round | int }}% OFF</small>
          </div>
          {% endif %}
        </div>
      </div>

      <!-- Product Info -->
      <div class="col-md-6">
        <div class="product-info">
          <div class="product-header">
            <h1 class="product-title">{{ product.name }}</h1>
            <div class="product-badges">
              <span class="badge badge-category">{{ product.category.name }}</span>
              {% if product.is_featured %}
              <span class="badge badge-featured">⭐ Featured</span>
              {% endif %}
            </div>
          </div>

          <div class="product-pricing">
            {% if product.original_price and product.original_price > product.price %}
            <span class="original-price">₹{{ product.original_price }}</span>
            {% endif %}
            <span class="current-price">₹{{ product.price }}</span>
            <span class="price-unit">per {{ product.unit }}</span>
          </div>

          <div class="product-description">
            <h5>Description</h5>
            <p>{{ product.description or "Fresh and high-quality product available at great prices." }}</p>
          </div>

          <div class="stock-availability">
            {% if product.stock_quantity > 0 %}
            <span class="in-stock">
              <i class="fas fa-check-circle"></i> 
              {{ product.stock_quantity }} {{ product.unit }} in stock
            </span>
            {% if product.stock_quantity <= product.min_stock %}
            <span class="low-stock-warning">⚠️ Low stock!</span>
            {% endif %}
            {% else %}
            <span class="out-of-stock">
              <i class="fas fa-times-circle"></i> 
              Out of stock
            </span>
            {% endif %}
          </div>

          {% if product.stock_quantity > 0 %}
          <div class="quantity-section">
            <label for="quantity">Quantity:</label>
            <div class="quantity-controls">
              <button type="button" class="quantity-btn" id="decreaseQty">-</button>
              <input type="number" id="quantity" name="quantity" value="1" 
                     min="1" max="{{ product.stock_quantity }}" class="quantity-input">
              <button type="button" class="quantity-btn" id="increaseQty">+</button>
            </div>
          </div>

          <div class="action-buttons">
            <button id="addToCartBtn" class="btn btn-primary btn-lg">
              <i class="fas fa-shopping-cart"></i> Add to Cart
            </button>
            
            {% if current_user.is_authenticated %}
            <button id="wishlistBtn" class="btn btn-outline-danger">
              <i class="fas fa-heart"></i>
              Add to Wishlist
            </button>
            {% endif %}
          </div>
          {% endif %}

          <!-- Product Details -->
          <div class="product-details">
            <h5>Product Details</h5>
            <div class="details-table">
              <div class="detail-row">
                <span class="detail-label">Category:</span>
                <span class="detail-value">{{ product.category.name }}</span>
              </div>
              <div class="detail-row">
                <span class="detail-label">Unit:</span>
                <span class="detail-value">{{ product.unit }}</span>
              </div>
              <div class="detail-row">
                <span class="detail-label">SKU:</span>
                <span class="detail-value">PRD-{{ product.id }}</span>
              </div>
              {% if product.updated_at %}
              <div class="detail-row">
                <span class="detail-label">Last Updated:</span>
                <span class="detail-value">{{ product.updated_at.strftime('%d %B, %Y') }}</span>
              </div>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Related Products -->
  {% if related_products %}
  <div class="related-products">
    <h3>Related Products</h3>
    <div class="row">
      {% for related_product in related_products %}
      <div class="col-md-3 col-sm-6 mb-3">
        <div class="card related-product-card">
          <img src="{{ url_for('static', filename='images/' + (related_product.image_url or 'no-image.jpg')) }}" 
               class="card-img-top" alt="{{ related_product.name }}">
          <div class="card-body">
            <h6 class="card-title">{{ related_product.name }}</h6>
            <p class="card-text">₹{{ related_product.price }}</p>
            <a href="{{ url_for('product_detail', product_id=related_product.id) }}" 
               class="btn btn-sm btn-outline-primary">View Details</a>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
  </div>
  {% endif %}
</div>

<style>
/* Global Styles */
body {
  background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

.product-detail-container {
  max-width: 1200px;
  margin: 2rem auto;
  padding: 0 2rem;
}

/* Breadcrumb */
.breadcrumb-nav {
  margin-bottom: 2rem;
}

.breadcrumb {
  background: rgba(255, 255, 255, 0.9);
  border-radius: 10px;
  padding: 1rem;
  backdrop-filter: blur(10px);
}

.breadcrumb a {
  color: #4caf50;
  text-decoration: none;
  font-weight: 500;
}

.breadcrumb a:hover {
  text-decoration: underline;
}

.breadcrumb-item.active {
  color: #666;
}

/* Product Content */
.product-content {
  background: rgba(255, 255, 255, 0.95);
  border-radius: 20px;
  padding: 2rem;
  margin-bottom: 3rem;
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
  backdrop-filter: blur(15px);
}

/* Product Image */
.product-image-container {
  position: relative;
  text-align: center;
  margin-bottom: 2rem;
}

.product-main-image {
  width: 100%;
  max-height: 500px;
  object-fit: cover;
  border-radius: 20px;
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
}

.sale-badge {
  position: absolute;
  top: 20px;
  right: 20px;
  background: linear-gradient(45deg, #ff6b6b, #ee5a24);
  color: white;
  padding: 1rem;
  border-radius: 15px;
  font-weight: bold;
  text-align: center;
  box-shadow: 0 5px 15px rgba(238, 90, 36, 0.4);
}

/* Product Info */
.product-info {
  padding: 1rem 0;
}

.product-title {
  font-size: 2.5rem;
  font-weight: 700;
  color: #2c5530;
  margin-bottom: 1rem;
  line-height: 1.2;
}

.product-badges {
  margin-bottom: 2rem;
}

.badge {
  padding: 0.5rem 1rem;
  border-radius: 20px;
  font-size: 0.9rem;
  font-weight: 600;
  margin-right: 1rem;
}

.badge-category {
  background: #e3f2fd;
  color: #1976d2;
}

.badge-featured {
  background: #fff3e0;
  color: #f57c00;
}

/* Pricing */
.product-pricing {
  margin: 2rem 0;
}

.original-price {
  text-decoration: line-through;
  color: #999;
  font-size: 1.3rem;
  margin-right: 1rem;
}

.current-price {
  font-size: 2.5rem;
  font-weight: 800;
  color: #2c5530;
}

.price-unit {
  color: #666;
  font-size: 1rem;
  margin-left: 0.5rem;
}

/* Description */
.product-description {
  margin: 2rem 0;
}

.product-description h5 {
  color: #2c5530;
  font-weight: 600;
  margin-bottom: 1rem;
}

.product-description p {
  font-size: 1.1rem;
  line-height: 1.6;
  color: #555;
}

/* Stock */
.stock-availability {
  margin: 2rem 0;
}

.in-stock {
  color: #2e7d32;
  font-weight: 600;
  font-size: 1.1rem;
}

.out-of-stock {
  color: #c62828;
  font-weight: 600;
  font-size: 1.1rem;
}

.low-stock-warning {
  color: #f57c00;
  font-size: 0.9rem;
  margin-left: 1rem;
}

/* Quantity Section */
.quantity-section {
  margin: 2rem 0;
}

.quantity-section label {
  font-weight: 600;
  color: #2c5530;
  margin-bottom: 0.5rem;
  display: block;
}

.quantity-controls {
  display: flex;
  align-items: center;
  gap: 1rem;
}

.quantity-btn {
  width: 50px;
  height: 50px;
  border: 2px solid #4caf50;
  background: transparent;
  color: #4caf50;
  font-size: 1.5rem;
  font-weight: bold;
  border-radius: 12px;
  cursor: pointer;
  transition: all 0.3s ease;
}

.quantity-btn:hover {
  background: #4caf50;
  color: white;
  transform: scale(1.05);
}

.quantity-input {
  width: 80px;
  height: 50px;
  text-align: center;
  border: 2px solid #4caf50;
  border-radius: 12px;
  font-size: 1.2rem;
  font-weight: 600;
  color: #2c5530;
}

.quantity-input:focus {
  outline: none;
  box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.3);
}

/* Action Buttons */
.action-buttons {
  display: flex;
  gap: 1rem;
  margin: 2rem 0;
  flex-wrap: wrap;
}

.btn {
  border-radius: 25px;
  font-weight: 600;
  transition: all 0.3s ease;
  border: none;
  padding: 1rem 2rem;
}

.btn-primary {
  background: linear-gradient(135deg, #4caf50, #45a049);
  color: white;
  font-size: 1.1rem;
  box-shadow: 0 5px 15px rgba(76, 175, 80, 0.4);
}

.btn-primary:hover {
  background: linear-gradient(135deg, #45a049, #388e3c);
  transform: translateY(-3px);
  box-shadow: 0 8px 25px rgba(76, 175, 80, 0.6);
}

.btn-outline-danger {
  border: 2px solid #f44336;
  color: #f44336;
  background: transparent;
}

.btn-outline-danger:hover {
  background: #f44336;
  color: white;
}

/* Product Details */
.product-details {
  margin-top: 3rem;
  padding-top: 2rem;
  border-top: 2px solid #e0e0e0;
}

.product-details h5 {
  color: #2c5530;
  font-weight: 600;
  margin-bottom: 1.5rem;
}

.details-table {
  background: #f8f9fa;
  border-radius: 15px;
  padding: 1.5rem;
}

.detail-row {
  display: flex;
  justify-content: space-between;
  padding: 0.75rem 0;
  border-bottom: 1px solid #e0e0e0;
}

.detail-row:last-child {
  border-bottom: none;
}

.detail-label {
  font-weight: 600;
  color: #2c5530;
}

.detail-value {
  color: #555;
}

/* Related Products */
.related-products {
  margin-top: 3rem;
}

.related-products h3 {
  color: #2c5530;
  font-weight: 700;
  margin-bottom: 2rem;
  text-align: center;
}

.related-product-card {
  border: none;
  border-radius: 15px;
  box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
  transition: transform 0.3s ease;
  overflow: hidden;
}

.related-product-card:hover {
  transform: translateY(-5px);
}

.related-product-card .card-img-top {
  height: 200px;
  object-fit: cover;
}

.related-product-card .card-body {
  padding: 1.5rem;
}

/* Responsive Design */
@media (max-width: 768px) {
  .product-detail-container {
    padding: 0 1rem;
  }
  
  .product-content {
    padding: 1.5rem;
  }
  
  .product-title {
    font-size: 2rem;
  }
  
  .current-price {
    font-size: 2rem;
  }
  
  .action-buttons {
    flex-direction: column;
  }
  
  .action-buttons .btn {
    width: 100%;
    margin-bottom: 1rem;
  }
  
  .quantity-controls {
    justify-content: center;
  }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const quantityInput = document.getElementById('quantity');
  const decreaseBtn = document.getElementById('decreaseQty');
  const increaseBtn = document.getElementById('increaseQty');
  const addToCartBtn = document.getElementById('addToCartBtn');
  const wishlistBtn = document.getElementById('wishlistBtn');

  // Quantity controls
  if (decreaseBtn) {
    decreaseBtn.addEventListener('click', function() {
      const currentValue = parseInt(quantityInput.value);
      if (currentValue > 1) {
        quantityInput.value = currentValue - 1;
      }
    });
  }

  if (increaseBtn) {
    increaseBtn.addEventListener('click', function() {
      const currentValue = parseInt(quantityInput.value);
      const maxValue = parseInt(quantityInput.getAttribute('max'));
      if (currentValue < maxValue) {
        quantityInput.value = currentValue + 1;
      }
    });
  }

  // Add to cart functionality
  if (addToCartBtn) {
    addToCartBtn.addEventListener('click', function() {
      const quantity = parseInt(quantityInput.value);
      const originalText = this.innerHTML;
      
      // Show loading state
      this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Adding...';
      this.disabled = true;
      
      fetch('/add_to_cart', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          product_id: {{ product.id }}, 
          quantity: quantity
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          // Success animation
          this.innerHTML = '<i class="fas fa-check"></i> Added to Cart!';
          this.classList.add('btn-success');
          this.classList.remove('btn-primary');
          
          // Show success notification
          showNotification(data.message, 'success');
          
          // Reset button after 3 seconds
          setTimeout(() => {
            this.innerHTML = originalText;
            this.classList.remove('btn-success');
            this.classList.add('btn-primary');
            this.disabled = false;
          }, 3000);
        } else {
          showNotification(data.message, 'error');
          this.innerHTML = originalText;
          this.disabled = false;
        }
      })
      .catch(error => {
        console.error('Error:', error);
        showNotification('An error occurred. Please try again.', 'error');
        this.innerHTML = originalText;
        this.disabled = false;
      });
    });
  }

  // Wishlist functionality
  if (wishlistBtn) {
    wishlistBtn.addEventListener('click', function() {
      const originalText = this.innerHTML;
      this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Adding...';
      this.disabled = true;
      
      fetch('/add_to_wishlist', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({product_id: {{ product.id }}})
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          this.innerHTML = '<i class="fas fa-heart"></i> Added to Wishlist!';
          this.classList.add('btn-danger');
          this.classList.remove('btn-outline-danger');
        }
        showNotification(data.message, data.success ? 'success' : 'error');
        
        setTimeout(() => {
          this.innerHTML = originalText;
          this.disabled = false;
        }, 2000);
      })
      .catch(error => {
        console.error('Error:', error);
        showNotification('An error occurred. Please try again.', 'error');
        this.innerHTML = originalText;
        this.disabled = false;
      });
    });
  }
});

// Notification system
function showNotification(message, type) {
  const notification = document.createElement('div');
  notification.className = `alert alert-${type === 'success' ? 'success' : 'danger'} notification-toast`;
  notification.innerHTML = `
    <strong>${type === 'success' ? 'Success!' : 'Error!'}</strong> ${message}
    <button type="button" class="close" onclick="this.parentElement.remove()">
      <span>&times;</span>
    </button>
  `;
  
  notification.style.cssText = `
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 1050;
    min-width: 350px;
    box-shadow: 0 5px 20px rgba(0,0,0,0.3);
    border-radius: 15px;
    animation: slideIn 0.3s ease;
  `;
  
  document.body.appendChild(notification);
  
  setTimeout(() => {
    if (notification.parentElement) {
      notification.style.animation = 'slideOut 0.3s ease';
      setTimeout(() => notification.remove(), 300);
    }
  }, 5000);
}

// Add keyframe animations
const style = document.createElement('style');
style.textContent = `
  @keyframes slideIn {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
  }
  @keyframes slideOut {
    from { transform: translateX(0); opacity: 1; }
    to { transform: translateX(100%); opacity: 0; }
  }
`;
document.head.appendChild(style);
</script>
{% endblock %}
